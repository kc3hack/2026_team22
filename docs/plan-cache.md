# 週間睡眠プランのキャッシュ仕組み

## 概要

週間睡眠プランは **「入力が同じならキャッシュを返し、変わったら LLM で再生成する」** 仕組みです。  
バックエンドで「入力のハッシュ」と「1ユーザー1行のキャッシュ」で判定し、フロントでは「いつ API を叩くか」でタイミングを制御しています。

---

## 1. バックエンドのキャッシュ判定

### 署名ハッシュ（signature_hash）

次の **4 種類の入力** を正規化した JSON を SHA-256 でハッシュし、`signature_hash` として使います。

| 入力                | 内容                                                               |
| ------------------- | ------------------------------------------------------------------ |
| **calendar_events** | ICS から取得したカレンダー予定（タイトル・開始・終了・終日フラグ） |
| **sleep_logs**      | 直近7件の睡眠ログ（日付・スコア・就寝予定時刻）                    |
| **settings**        | 起床時刻・希望睡眠時間・**today_override**（今日の就寝・起床オーバーライド、任意） |
| **today_date**      | 今日の日付 YYYY-MM-DD                                             |

- 実装: `backend/app/domain/plan/value_objects.py` の `build_signature_hash()`
- 辞書はキーソート、**リスト（calendar_events / sleep_logs）は内容でソート**してからハッシュするため、フロントの送信順や ICS の取得順に依存せず、**同じ内容なら必ず同じハッシュ**になりキャッシュが安定する。
- **日時文字列**（`start` / `end` / `scheduled_sleep_time` 等）は **秒単位に正規化**（ミリ秒・タイムゾーン表記を捨てる）してからハッシュするため、`toISOString()` の表記揺れでハッシュが変わらない。

### キャッシュの保存形式

- **テーブル**: `sleep_plan_cache`
- **1ユーザー1行**: `user_id` が主キー。同じユーザーで新しいプランを保存するたびに **上書き** されます。
- **列**: `user_id`, `signature_hash`, `plan_json`, `created_at`

### バックエンドの動作フロー

```
1. リクエスト受信（user_id, calendar_events, sleep_logs, settings, today_date, force）。settings に today_override を含む
2. 上記4入力から signature_hash を計算
3. force=True なら → キャッシュを見ずに LLM で生成 → 保存 → 返却（cache_hit: false）
4. force=False なら:
   - (user_id, signature_hash) でキャッシュを検索
   - ヒット → 保存済み plan_json を返却（cache_hit: true）
   - ミス → LLM で生成 → (user_id, signature_hash, plan_json) で upsert → 返却（cache_hit: false）
```

- 実装: `backend/app/application/plan/get_or_create_plan.py`

---

## 2. 何を変えるとプランが「再生成」されるか

**署名に含まれるいずれかが変わると、`signature_hash` が変わり、キャッシュミス → LLM で再生成されます。**

| 変更内容                 | 再生成のタイミング                                                        |
| ------------------------ | ------------------------------------------------------------------------- |
| **睡眠設定**             | 起床時刻・睡眠時間を変更して保存したあと、次にプラン取得が走ったとき      |
| **今日のオーバーライド** | 今日だけの就寝/起床を設定・変更したあと、次にプラン取得が走ったとき       |
| **睡眠ログ**             | スコアを追加・更新したあと、次にプラン取得が走ったとき（直近7件が変わる） |
| **カレンダー（ICS）**    | ICS URL や予定の追加・変更のあと、次にプラン取得が走ったとき              |

「次にプラン取得が走る」のは、**フロントのタイミング制御**（下記）に従います。

---

## 3. フロントエンドの「いつ API を叩くか」

### タイミング制御（SleepPlanScreen + sleepPlanStore）

- **画面がフォーカスされるたびに** `fetchPlan()` を呼ぶ（`useFocusEffect` 使用）。
  - 初回表示時だけでなく、**設定タブで希望時間などを変更してプランタブに戻ったとき**も再取得される。
- **スロットルは廃止**：同日・5分以内のスキップは行わない。フォーカスごとに API を呼び、バックエンドで同じ入力ならキャッシュを返すため、無駄な LLM 呼び出しは発生しない。

### ローディングアニメーションの出し分け

- **キャッシュヒット**（バックエンドが短時間で返す）→ ローディングアニメーションは **表示しない**。
- **AI生成**（キャッシュミスで LLM が動く＝応答に時間がかかる）→ **1秒を超えて応答が返らなかったときだけ** ローディングアニメーションを表示する。
- 実装: フロントで「取得開始から 1 秒経過したら `isLoading` を true にする」遅延ローディングを採用。キャッシュなら 1 秒以内に返るため `isLoading` が true にならず、AI 生成時だけローディングが表示される。
- プラン未取得時（初回など）は、取得中は即ローディング表示。プラン取得済みで再取得するとき（タブ戻りなど）は、上記の遅延ローディングでキャッシュ時はアニメーションを出さない。

### 強制再生成について

- プルダウンでの強制更新は廃止済み。
- エラー時の「再試行」は `fetchPlan()`（force なし）なので、同じ入力ならキャッシュが返る。

---

## 4. 動作まとめ

| やりたいこと                                           | どうするか                                                                                                                                                                        |
| ------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **設定・ログ・予定を変えたあとで新しいプランにしたい** | 設定やログを変更したうえで、**プランタブ（週間睡眠プラン画面）を開く**。フォーカス時に毎回 API が呼ばれ、入力が変わっていればバックエンドで再生成されて新しいプランが表示される。 |
| **同じ入力のまま再度表示したい**                       | そのままプラン画面を開く。API は呼ばれるが、同じ入力なのでバックエンドがキャッシュを返し、LLM は呼ばれない。                                                                      |
| **バックエンド側で強制再生成したい**                   | 現状フロントから `force=true` を送る経路はない（プルダウン廃止のため）。必要なら API を `?force=true` で直接呼ぶか、機能を追加する必要がある。                                    |

---

## 5. 関連ファイル

- **署名ハッシュ**: `backend/app/domain/plan/value_objects.py`
- **ユースケース（キャッシュ判定・LLM 呼び出し）**: `backend/app/application/plan/get_or_create_plan.py`
- **キャッシュ永続化**: `backend/app/infrastructure/persistence/repositories/sleep_plan_cache_repository.py`
- **フロントの取得タイミング**: `src/features/sleep-plan/sleepPlanStore.ts`
