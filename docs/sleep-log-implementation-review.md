# 睡眠ログ実装の考察

フロント・バックエンド・想定ユースケースを踏まえた睡眠ログ周りの実装状態の整理と、不足・改善点の考察。

---

## 1. 現状の実装サマリ

### 1.1 バックエンド API

| 操作 | エンドポイント | 実装 | 備考 |
|------|----------------|------|------|
| 一覧取得 | `GET /api/v1/sleep-logs?limit=7` | ✅ | 日付降順、limit 1–100 |
| 新規作成 | `POST /api/v1/sleep-logs` | ✅ | 1日1ログ制約、重複時 409 |
| 部分更新 | `PATCH /api/v1/sleep-logs/:id` | ✅ | 日付・スコア・ペナルティ・気分など任意項目 |
| 削除 | なし | ❌ | - |

- **認証**: 全エンドポイントで `ensure_current_user`（JWT → user_id 注入）済み。
- **1日1ログ**: DB に `UNIQUE(user_id, date)`、同一日で 2 件目は 409。編集で日付変更時も他ログと重複すれば 409。
- **バリデーション**: Pydantic で score 0–100、mood 1–5、日付・数値範囲を検証。

### 1.2 フロント状態管理（Zustand）

| 操作 | 実装 | 呼び出し元 |
|------|------|------------|
| `fetchLogs(limit?)` | ✅ API GET → store 更新 | HomeScreen, SleepLogScreen, sleepPlanStore |
| `addLog(entry)` | ✅ API POST → 先頭に追加 | **どこからも未使用** |
| `setMood(logId, mood)` | ✅ API PATCH → 該当ログ差し替え | HomeScreen（MorningReviewCard） |
| `updateLog(logId, updates)` | ✅ API PATCH（部分更新）→ store 更新 | SleepLogEditModal |
| `removeLog(id)` | ローカルのみ（API 非呼び出し） | 未使用 |
| `clearLogs` | ローカル初期化 | 未使用 |

- **エラー**: `fetchLogs` 失敗時は `error` をセットし、SleepLogScreen で表示・再試行可能。`addLog` / `setMood` は throw のため、呼び出し元で catch しないとクラッシュや無反応になりうる。

### 1.3 フロント画面・フロー

- **ホーム**: ログ取得、最新ログで朝の振り返りカード表示、`setMood` で気分送信。
- **睡眠ログタブ**: 一覧・週間トレンド・最新スコア表示。カード展開時に「編集」でモーダルから部分更新可能。
- **睡眠プラン**: store の `logs.slice(0, 7)` を `SleepLogSummary[]` に変換してプラン API に送信。

**ログの「新規作成」を行う画面・フローは現状ない。**

---

## 2. 想定ユースケースと充足度

| ユースケース | 期待動作 | 現状 | 充足度 |
|-------------|----------|------|--------|
| 昨夜の睡眠を振り返る | 一覧・詳細・週間トレンドを見る | 一覧・詳細・チャートあり | ✅ |
| 朝に「今日の気分」を記録 | 最新ログに mood を保存 | MorningReviewCard → setMood | ✅ |
| AI プランに履歴を渡す | 直近ログをプラン API に送る | sleepPlanStore で 7 件送信 | ✅ |
| **就寝モニター後にスコアを保存** | 夜の準備スコアを 1 日 1 件保存 | **addLog を呼ぶ画面・バックグラウンドなし** | ❌ |
| 誤ったログを削除する | 1 件削除 | API に DELETE なし、removeLog はローカルのみ | △ |
| 過去のスコア・日付を修正する | 既存ログを編集 | PATCH 部分更新 + 睡眠ログ画面の編集モーダル | ✅ |

結論: **参照・気分更新・プラン連携は足りている。不足しているのは「ログをいつ・どこで作成するか」のフローと、削除・編集の要否。**

---

## 3. 不足・検討ポイント

### 3.1 ログ作成フローが未接続（重要）

- **現状**: `addLog` と `createSleepLogViaApi` は実装済みだが、**どの画面・どのタイミングでも呼ばれていない**。
- **想定される接続先**:
  - **朝フロー**: 起床後に「昨夜のスコアを確定して保存」する画面 or 自動保存。
  - **バックグラウンド**: 照度センサー等のモニター終了時に、集計結果（スコア・ペナルティ・警告）を 1 日 1 件で `addLog` する。
- **推奨**: まず「いつ 1 日分のログを作るか」を仕様で決め、そのタイミングで `addLog` を必ず 1 回呼ぶようにする（朝の確定ボタン or モニター終了時の自動保存など）。

### 3.2 同一日付の重複（対応済み）

- **現状**: `UNIQUE(user_id, date)` を migration 003 で追加。同一日で 2 件目は 409。編集で日付を他ログと被るように変更した場合も 409。

### 3.3 削除 API の有無

- **現状**: DELETE なし。`removeLog` は store のローカル削除のみで、再 fetch で復活する。
- **必要性**: 誤登録の削除やテストデータ整理が必要なら、`DELETE /api/v1/sleep-logs/:id` を追加し、`removeLog` から呼ぶとよい。

### 3.4 スコア・日付の更新（対応済み）

- **現状**: PATCH で日付・スコア・ペナルティ・警告・気分を部分更新可能。フロントは睡眠ログ画面の「編集」モーダルから送信。

### 3.5 エラー・UX

- **setMood 失敗時**: `void setMood(...)` で投げっぱなしだと、ユーザーに失敗が伝わらない。トーストやインラインエラー + 再試行を検討。
- **addLog 失敗時**: 将来 addLog を呼ぶ画面では、try/catch でメッセージ表示と再送ができるとよい。
- **楽観的更新**: setMood を先に UI 更新してから API を呼び、失敗時だけロールバックすると体感が良くなる。

### 3.6 その他

- **scheduledSleepTime**: フロントは `number`（ms）、API は ISO 文字列。0 のときプラン用に `new Date(0).toISOString()` が渡るため、プラン側で「未設定」として扱う必要がある。
- **取得件数**: デフォルト 7 件で週間プラン・一覧は足りる。長期間の履歴が必要なら、limit の引き上げかページネーションの検討。

---

## 4. まとめ

| 観点 | 十分か | メモ |
|------|--------|------|
| API の CRUD（取得・作成・気分更新） | ✅ | 削除・全項目更新は未実装 |
| ドメイン・UseCase の分離 | ✅ | 責務は明確 |
| フロントの取得・表示・気分送信 | ✅ | 一覧・詳細・プラン連携は実装済み |
| **ログ作成を起こすフロー** | ❌ | addLog の呼び出し元がまだない（下記「いつ add するか」参照） |
| 1日1ログ・編集 | ✅ | 制約・PATCH 部分更新・編集 UI 済み |

**結論**: 睡眠ログの「見る・気分を付ける・編集・プランに渡す」は実装済み。**「いつ addLog を呼ぶか」を決めて 1 箇所で必ず呼ぶようにすると、一連の流れが完成する。**

---

## 5. いつ addLog を呼ぶか（考察）

ログは「その日 1 件」に限定されているため、**「その日のログをいつ作成するか」を 1 つに決める**必要がある。

### 5.1 候補となるタイミング

| タイミング | 内容 | メリット | デメリット |
|-----------|------|----------|------------|
| **A. 朝の確定時** | 起床後にアプリを開き、「昨夜の結果を保存」ボタン or 朝の振り返りカードで「記録する」 | ユーザーが意図して保存するので納得感がある。モニター未使用でも手動で日付・スコアを入れられる。 | 保存し忘れの可能性。 |
| **B. モニター終了時** | 就寝モニター（照度など）を止めたタイミングで、集計結果を 1 件 POST | 手間がなく、データが確実に残る。 | モニターを使わない日はログができない。終了判定（翌朝の「停止」タップか、時間ベースか）の設計が必要。 |
| **C. 手動「記録を追加」** | 睡眠ログ画面などに「記録を追加」があり、日付・スコアを入力して POST | どの日でも遡って記録できる。 | 毎日の習慣になりにくく、重複（同じ日で 2 回押す）は 409 で弾く必要あり。 |

### 5.2 推奨の組み合わせ

- **主経路**: **A（朝の確定）** を「ログ作成の公式タイミング」にする。  
  - モニターを使った夜は、翌朝の「朝の振り返り」で「昨夜のスコアを保存」として addLog を 1 回呼ぶ（モニター結果を AsyncStorage/Zustand に溜めておき、ここで送る想定）。  
  - モニターを使わなかった夜は、同じ朝フローで「手動で日付・スコアを入力して保存」できるようにする。
- **補助**: **C（手動追加）** を「遅れ・取りこぼし用」として用意する（睡眠ログ画面に「記録を追加」）。同じ日で既にログがあれば 409 を表示して上書きはしない（編集は既存の編集モーダルで対応）。

### 5.3 実装の進め方

1. **朝フローで「昨夜のログがない場合」に保存 UI を出す**  
   - ホーム or 朝の振り返りで「最新ログの date ≠ 昨日」なら「昨夜を記録」を表示。  
   - タップで「昨日の日付・スコア・ペナルティ」を入力（モニター結果があれば初期値にセット）→ `addLog` を 1 回呼ぶ。  
2. **モニター終了時にログを作る場合は**  
   - バックグラウンド or フォアグラウンドでモニターを止めたタイミングで、その日の date と集計結果を `addLog` に渡す。  
   - 既にその日のログがある場合は 409 になるので、そのときは「既に記録済み」と表示するか、何もしない。  
3. **「記録を追加」**  
   - 睡眠ログ画面に「＋ 記録を追加」を置き、日付・スコア等を入力して `addLog`。409 時は「その日は既に記録があります」と表示。

このように「朝の確定」を主、「手動追加」を補助にすると、いつ add するかが明確になり、1日1ログ制約とも整合する。
