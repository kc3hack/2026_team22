<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SleepSupportApp ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³</title>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.5/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      }
    });
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f5f5f5;
      min-height: 100vh;
    }
    h1 {
      color: #333;
      margin-bottom: 1.5rem;
    }
    .mermaid {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    h2 { color: #333; margin-top: 2.5rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>SleepSupportApp ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³</h1>
  <h2>ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ¢ãƒã‚¤ãƒ«ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼‰</h2>
  <pre class="mermaid">
flowchart TD
    %% --- å®šç¾©ã‚¨ãƒªã‚¢ ---
    User["ãƒ¦ãƒ¼ã‚¶ãƒ¼ ğŸ™‹"]
    
    subgraph MobileApp ["ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª Flutter / React Native"]
        noteApp["è²¬å‹™: UIè¡¨ç¤º, ãƒ‡ãƒã‚¤ã‚¹æ©Ÿèƒ½åˆ©ç”¨"]
        UI["UI / ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ğŸ“Š"]
        LocalAlarm["ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ©ãƒ¼ãƒ ç®¡ç† â° ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œä¿éšœ"]
        Camera["ã‚«ãƒ¡ãƒ©æ’®å½±æ©Ÿèƒ½ ğŸ“· é«˜é›£æ˜“åº¦ãƒŸãƒƒã‚·ãƒ§ãƒ³ç”¨"]
        CredentialManager["ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†"]
    end
    
    subgraph Backend ["â˜ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ Firebase"]
        noteBE["è²¬å‹™: ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ, ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–"]
        Auth["Authentication ğŸ” Googleãƒ­ã‚°ã‚¤ãƒ³"]
        DB["Firestore DB ğŸ—„ï¸ User/Plans/Cache/Logs"]
        
        subgraph CloudFunctions ["Cloud Functions ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹"]
            Logic_Plan["ğŸ”„ è¨ˆç”»ç”Ÿæˆãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯"]
            Logic_Vision["ğŸ‘ï¸ ç”»åƒåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯"]
            Logic_Learning["ğŸ“ˆ å­¦ç¿’ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ãƒ­ã‚¸ãƒƒã‚¯"]
        end
    end
    
    subgraph ExternalServices ["ğŸŒ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹"]
        GCal["ğŸ“… Google Calendar API"]
        AI_LLM["ğŸ¤– AIãƒ¢ãƒ‡ãƒ« LLM Gemini Pro/Flash, GPT-4o JSONç”Ÿæˆ"]
        AI_Vision["ğŸ–¼ï¸ AIãƒ¢ãƒ‡ãƒ« Vision Gemini Pro Vision, GPT-4o ç”»åƒèªè­˜"]
    end

    %% --- ãƒ•ãƒ­ãƒ¼ã‚¨ãƒªã‚¢ ---
    
    %% A. åˆæœŸè¨­å®šãƒ•ã‚§ãƒ¼ã‚º
    User -->|1. ã‚¢ãƒ—ãƒªèµ·å‹• ãƒ­ã‚°ã‚¤ãƒ³| Auth
    Auth -->|èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³| CredentialManager
    CredentialManager -->|æ¨©é™åˆ©ç”¨| GCal
    
    %% B. ãƒ‡ã‚¤ãƒªãƒ¼ãƒ»ãƒªãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚° ãƒ•ãƒ­ãƒ¼
    noteB["B. ãƒ‡ã‚¤ãƒªãƒ¼ãƒ»ãƒªãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°"]
    UI -->|2. äºˆå®šãƒ‡ãƒ¼ã‚¿å–å¾—| GCal
    UI -->|3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ äºˆå®š+ç¡çœ è² å‚µ+è¨­å®š| Logic_Plan
    
    noteLogic["ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ å†ªç­‰æ€§ãƒã‚§ãƒƒã‚¯"]
    Logic_Plan -->|æœ€æ–°ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•ã„åˆã‚ã› Hash Query| DB
    
    DB -->|ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³è¿”å´| Logic_Plan
    Logic_Plan -->|ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚ 4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡ Temp=0| AI_LLM
    AI_LLM -->|æ–°é€±é–“ãƒ—ãƒ©ãƒ³ JSON| Logic_Plan
    Logic_Plan -->|æ–°ãƒ—ãƒ©ãƒ³ and ãƒãƒƒã‚·ãƒ¥ä¿å­˜| DB
    Logic_Plan -->|æœ€æ–°ãƒ—ãƒ©ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹| UI
    
    UI -->|5. æ˜æ—¥ã®ã‚¢ãƒ©ãƒ¼ãƒ ã‚»ãƒƒãƒˆ| LocalAlarm
    
    %% C. èµ·åºŠãƒ»ã‚¢ãƒ©ãƒ¼ãƒ è§£é™¤ ãƒ•ãƒ­ãƒ¼
    noteC["C. ã‚¢ãƒ©ãƒ¼ãƒ å®Ÿè¡Œãƒ»è§£é™¤"]
    LocalAlarm -->|6. ã‚¢ãƒ©ãƒ¼ãƒ èµ·å‹• ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯| User
    User -->|åœæ­¢æ“ä½œ é«˜é›£æ˜“åº¦æ™‚| Camera
    Camera -->|7. æ’®å½±ç”»åƒé€ä¿¡| Logic_Vision
    Logic_Vision -->|8. ç”»åƒåˆ¤å®šä¾é ¼| AI_Vision
    AI_Vision -->|åˆ¤å®šçµæœ OK/NG| Logic_Vision
    Logic_Vision -->|è§£é™¤æŒ‡ä»¤| UI
    UI -->|9. ã‚¢ãƒ©ãƒ¼ãƒ åœæ­¢| LocalAlarm
    
    %% D. æŒ¯ã‚Šè¿”ã‚Šãƒ»å­¦ç¿’ ãƒ•ãƒ­ãƒ¼
    noteD["D. æŒ¯ã‚Šè¿”ã‚Šãƒ»å­¦ç¿’"]
    User -->|10. å®Ÿç¸¾ãƒ»æ—¥è¨˜å…¥åŠ›| UI
    UI -->|ãƒ­ã‚°ä¿å­˜ sleepLogs| DB
    
    %% å®šæœŸå®Ÿè¡Œ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
    DB -.->|é€±æ¬¡ãƒãƒƒãƒç­‰| Logic_Learning
    Logic_Learning -.->|è¨­å®šæ›´æ–°| DB

    %% ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
    classDef mobile fill:#f9f,stroke:#333,stroke-width:2px,color:black;
    classDef backend fill:#ccf,stroke:#333,stroke-width:2px,color:black;
    classDef external fill:#ff9,stroke:#333,stroke-width:2px,color:black;
    classDef noteStyle fill:#eee,stroke:none,color:#666;
    
    class UI,LocalAlarm,Camera,CredentialManager mobile;
    class Auth,DB,Logic_Plan,Logic_Vision,Logic_Learning backend;
    class GCal,AI_LLM,AI_Vision external;
    class noteApp,noteBE,noteB,noteC,noteD,noteLogic noteStyle;
  </pre>

  <h2>æœã®ãƒ›ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºãƒ•ãƒ­ãƒ¼ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰</h2>
  <pre class="mermaid">
sequenceDiagram
    participant App as ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒª
    participant Server as ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API
    participant DB as DB Cache
    participant AI as AI LLM

    Note over App,Server: æœãƒ»ãƒ›ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºãƒ»æ›´æ–°
    App->>+Server: ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šï¼‹ç¡çœ ãƒ­ã‚°ï¼‹è¨­å®šï¼‰

    Note over Server: ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆï¼ˆSignatureï¼‰

    Server->>DB: ãƒãƒƒã‚·ãƒ¥å€¤ã¨ãƒ—ãƒ©ãƒ³å•ã„åˆã‚ã›
    DB-->>Server: å‰å›ãƒãƒƒã‚·ãƒ¥ã¨ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿

    alt ãƒãƒƒã‚·ãƒ¥ä¸€è‡´ Cache Hit
        Note over Server: å†è¨ˆç®—ä¸è¦
        Server-->>App: ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³è¿”å´
    else ãƒãƒƒã‚·ãƒ¥ä¸ä¸€è‡´ Cache Miss
        Note over Server: AIã§å†è¨ˆç®—
        Server->>AI: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡ Temperature=0
        AI-->>Server: é€±é–“ç¡çœ ãƒ—ãƒ©ãƒ³ JSON
        Server->>DB: æ–°ãƒ—ãƒ©ãƒ³ã¨ãƒãƒƒã‚·ãƒ¥ä¿å­˜
        Server-->>App: æ–°ãƒ—ãƒ©ãƒ³è¿”å´
    end

    deactivate Server
  </pre>
</body>
</html>
